# SPDX-FileCopyrightText: Â© 2024 Matt Williams <matt.williams@bristol.ac.uk>
# SPDX-License-Identifier: MIT
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: conch-config
data:
  conch.toml: |
    issuer = "http://keycloak:8080/realms/conch"
    signing_key_path = "/signing_key/key"
    [services."ai.isambard"]
    hostname = "ai-p1.access.isambard.ac.uk"
    proxy_jump = "ai.login.isambard.ac.uk"
---
apiVersion: v1
kind: Deployment
metadata:
  name: conch
  labels:
    app: conch
spec:
  replicas: 1
  selector:
    matchLabels:
      app: conch
  template:
    metadata:
      labels:
        app: conch
    spec:
      containers:
        - name: conch
          image: localhost/conch:latest
          args: ["--port=3000", "--config=/config/conch.toml"]
          env:
            - name: RUST_LOG
              value: debug
          ports:
            - containerPort: 3000
            - hostPort: 3000
          volumeMounts:
            - mountPath: "/signing_key"
              name: conch-signing-key-volume
              read-only: true
            - mountPath: "/config"
              name: conch-config-volume
              read-only: true
          securityContext:
            readOnlyRootFilesystem: true
      volumes:
          - name: conch-signing-key-volume
            secret:
              secretName: conch-signing-key-secret
          - name: conch-config-volume
            configMap:
              name: conch-config
---
apiVersion: v1
kind: Pod
metadata:
  name: keycloak
spec:
  containers:
    - name: keycloak
      image: quay.io/keycloak/keycloak:25.0
      args: ["start-dev", "--http-port=8080"]
      env:
        - name: KEYCLOAK_ADMIN
          value: admin
        - name: KEYCLOAK_ADMIN_PASSWORD
          value: admin
      ports:
        - containerPort: 8080
        - hostPort: 8080
